stages:                                                         # Definuje fáze pipeline
  - build                                                       # 1. fáze: build
  - test                                                        # 2. fáze: test
  - tag                                                         # 3. fáze: tag

variables:                                                      # Proměnné pro celý pipeline
  IMAGE_NAME: "myApp"                                           # Název docker obrazu

build:                                                          # Job: build
  stage: build                                                  # Patří do fáze build
  script:                                                       # Co se má spustit
    - BUILD_ID=$CI_PIPELINE_ID                                  # Vezme ID pipeline jako tag
    - docker build -t $IMAGE_NAME:$BUILD_ID .                   # Postaví docker obraz
    - echo "Postaveno: $IMAGE_NAME:$BUILD_ID"                   # Vypíše info
  only:                                                         # Spustí se jen na
    - branches                                                  # větvích (ne na MR)

test:                                                           # Job: test
  stage: test                                                   # Patří do fáze test
  script:                                                       # Simulace testů
    - echo "Testuji aplikaci..."                                # Vypíše
    - sleep 1                                                   # Počká 1 sekundu
    - echo "Testy PROŠLY"                                       # Vypíše úspěch
  only:
    - branches

create_tag:                                                     # Job: vytvoření tagu
  stage: tag                                                    # Poslední fáze
  script:                                                       # Co se má spustit
    - BUILD_ID=$CI_PIPELINE_ID                                  # ID pipeline = tag
    - git tag myApp/$BUILD_ID                                   # Vytvoří git tag: myApp/123
    - git push origin myApp/$BUILD_ID                           # Pushne tag na GitLab
  only:
    - branches                                                  # Jen na větvích
  when: on_success                                              # Jen když předchozí joby projdou
                                                             # Konec zápisu
